name: Android CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # ==========================================
    # ğŸ”´ æ³¨é‡Šæ‰ "Fix code style" æ­¥éª¤
    # å› ä¸ºäº‘ç«¯æ— æ³•è‡ªåŠ¨ä¿®å¤ä¸”ä¼šå¯¼è‡´æ„å»ºä¸­æ–­
    # ==========================================
    # - name: Fix code style
    #   run: ./gradlew ktlintFormat

    # ==========================================
    # ğŸ”´ æ³¨é‡Šæ‰ "Pre-compile critical modules"
    # è¿™ä¸€æ­¥å®¹æ˜“å› ä»»åŠ¡ä¸å­˜åœ¨æˆ–æ£€æŸ¥å¤±è´¥è€Œä¸­æ–­
    # æˆ‘ä»¬ç›´æ¥åœ¨æœ€åä¸€æ­¥æ„å»ºæ—¶ä¸€å¹¶å¤„ç†
    # ==========================================
    # - name: Pre-compile critical modules
    #   run: ./gradlew :core:utils:build ...

    # ==========================================
    # âœ… æ ¸å¿ƒæ„å»ºæ­¥éª¤ï¼šè·³è¿‡æ‰€æœ‰æ£€æŸ¥ï¼Œç›´æ¥æ‰“åŒ…
    # ==========================================
    - name: Build with Gradle (Skip Checks)
      run: |
        export storePassword=${{ secrets.STORE_PASSWORD }}
        export keyAlias=${{ secrets.KEY_ALIAS }}
        export keyPassword=${{ secrets.KEY_PASSWORD }}
        export storeFile=${{ secrets.STORE_FILE }}
        # æ·»åŠ  -x å‚æ•°è·³è¿‡ KtLint æ£€æŸ¥å’Œæµ‹è¯•
            # åˆ›å»ºæˆ–ä¿®æ”¹gradle.propertiesä»¥è§£å†³å˜ä½“æ­§ä¹‰
        #echo "android.enableBuildCache=false" >> gradle.properties
        #echo "org.gradle.caching=false" >> gradle.properties
        #echo "org.gradle.configuration-cache=false" >> gradle.properties
        #echo "org.gradle.parallel=true" >> gradle.properties
    
        ./gradlew clean
        # å°è¯•ä½¿ç”¨æ›´æ˜ç¡®çš„æ„å»ºå‘½ä»¤
        ./gradlew :app:assembleFullRelease \
          -Pandroid.dependencyResolution.enableVariantSelection=false \
          -x ktlintCheck -x ktlintFormat -x test
    - name: Archive production artifacts
      uses: actions/upload-artifact@v4
      with:
        name: aaps
        path: app/build/outputs/apk/full/release
